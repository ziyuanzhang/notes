# 内存控制 (原文:深入浅出 Node.js)

- V8 的内存限制：64 位系统下：1.4G，32 位系统下 0.7G；  
  比如：node 无法将一个 2G 的文件读入内存中进行字符串分析处理（物理内存为 32G 也不行）；  
  破解限制的 2 种方法：必须初始化时

  1. node --max-new-space-size=1024 test.js // 单位为 KB
  2. node --max-old-space-size=1700 test.js // 单位为 MB

- V8 为何要限制大小：
  表层：V8 为浏览器设计的，不太可能用到大内存场景；
  深层：V8 的垃圾回收机制的限制；1.5G 垃圾回收堆内存，V8 做一次小的垃圾回收耗时 50 毫秒以上，做一次非增量式的垃圾回收要 1 秒以上，垃圾回收 js 线程暂停执行；前端和后端都无法接受。

## V8 的垃圾回收机制

- V8 将内存分为“新生代”和“老生代”两代；

  1. 新生代：中的对象为存活时间较短的对象；
     设置新生代内存空间的最大值：-max-new-space-size
     默认设置下：新生代最大内存 32MB（64 位系统），16MB（32 位系统）【可用的再减半】

  2. 老生代：中的对象为存活时间较长或常驻内存的对象；
     设置老生代内存空间的最大值：-max-old-space-size

- V8 推的整休大小 = 新生代所用内存空间 + 老生代的内存空间。
  V8 使用的内存没有办法根据使用情况自动扩充，当内存分配过程中超过极限值时，就会引起进程出错。

chrome 浏览器每个选项卡一个 V8,内存绰绰有余。
web 服务器会话一般通过内存储存，访问量大导致老生代中的对象剧增，造成清理/整理耗时，和内存紧张。
