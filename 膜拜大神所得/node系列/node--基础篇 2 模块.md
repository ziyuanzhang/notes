# node--基础篇 2--模块

## 模块

- 在 node 中，一个文件就是一个模块，将方法挂载在 exports 对象上 作为属性即可定义导出的方式

  ```code
   exports.add=function(){}
  ```

- 在模块中存在一个 module 对象，它代表模块自身，而 exports 是 module 的属性。

- 在模块中，上下文提供了：

  1. require()方法来引入外部模块；
  2. exports 对象用于导出当前模块的方法或者变量，并且它是唯一导出的出口；

## 模块加载

- 在 Node 中引入模块，需要经过 3 个步骤：

1. 路径分析
2. 文件定位
3. 编译执行

- node 模块分为两类：1、核心模块，2、用户编写的模块（文件模块）
  核心模块：在 node 源代码的编译过程中，编译进了二进制执行文件，node 进程启动时直接加载到内存中运行，跳过“文件定位”和“编译执行”，并且在路径分析中优先判断，加载速度最快；
  文件模块（用户编写的模块）：在运行时动态加载，需要完整的“路径分析”、“文件定位”、“编译执行”过程，速度比核心模块慢；

- 优先从缓存加载
  1. 相同：浏览器仅仅缓存文件；node 缓存的时编译和执行之后的对象；
  2. 不同：核心模块的缓存检查先于文件模块的检查；

## 模块标识符

require()方法接受一个标识符作为参数，基于标识符进行模块查找；

- 在 node 中 模块标识分为：

  1. 核心模块，（如 http、fs、path 等）；

     核心模块的优先级仅次于缓存加载，node 源码时已经编译为二进制代码，加载最快。

  2. 路径形式的文件模块，（.或..开始的相对路径文件、 以/开始的绝对路径文件）；

     路径分析时，require()方法会将路径转化为真是路径，并以真实路径为索引，将编译后的结果存到缓存中，下次加载更快；

  3. 非路径形式的文件模块，（如自定义的 connect 模块、一个文件或包的形式）；

     在加载的过程中，Node 会逐个尝试模块路径中的路径，直到找到目标文件位置。
     可以看出，当前文件的路径越深，模块查找耗时会越多，这是自定义模块的加载速度最慢的原因。

     - “模块路径”:具体表现为一个路径组成的数组，

     ```code
     创建module_path.js文件，内容为console.log(module.paths);
     将其放在任意一个目录中，执行node module_path.js。
       linux下：
       [ '/home/jackson/research/node_modules',
         '/home/jackson/node_modules',
         '/home/node_modules',
         '/node_modules' ]

       Windows 下：[ 'c:\\nodejs\\node_modules', 'c:\\node_modules' ]

     ```

     - “模块路径”的生成规则如下：

       1. 当前文件目录下的 node_modules 目录。
       2. 父目录下的 node_modules 目录。
       3. 父目录的父目录下的 node_modules 目录。
       4. 沿路径向上逐级递归，直到根目录下的 node_modules 目录。

- 文件扩展名分析：require()中不包含文件扩展名时，Node 会按.js、.json、.node 的次序补足扩展名，主次尝试。
  在尝试的过程中，需要调用 fs 模块同步阻塞式的判断文件是否存在，因为 Node 是单线程的，所以这里是一个会引起性能问题的地方

- 目录分析和包

  1. 在分析标识符的过程中，require()通过分析文件扩展名之后，可能没有查找到对应文件，但却得到个目录，这在引入“自定义模块”和“逐个模块路径”进行查找时经常会出现，此时 Node 会将目录当做个包来处理。

  2. 在这个过程中，Node 对 CommonJS 包规范进行了一定程度的支特。首先，Node 在当前目录下查找 package.json(CommonJS 包规范定义的包描述文件)，通过]SON.parse()解析出包描述对象，从中取出 main 属性指定的文件名进行定位。如果文件名缺少扩展名，将会进入扩展名分析的步骤。

  3. 而如果 main 属性指定的文件名错误，或者压根没有 package.json 文件，Node 会将 index 当做默认文件名，然后依次查找 index.js、index.json、index.node。

  4. 如果在目录分析的过程中没有定位成功任何文件，则自定义模块进入下一个模块路径进行查找。如果模块路径数组都被遍历完毕，依然没有查找到目标文件，则会抛出查找失败的异常。
