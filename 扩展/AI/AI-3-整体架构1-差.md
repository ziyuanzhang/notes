# AI-3-æ•´ä½“æ¶æ„

ç”¨æˆ· â†’ RAGFlow â†’ message â†’ Agent â†’ tool â†’ Agent è§‚å¯Ÿ â†’ è¿”å›

- ä»€ä¹ˆæ—¶å€™ç”¨è¿™ç§æ¶æ„å¯ä»¥æ¥å—
  - âœ” demo
  - âœ” å•è½®é—®ç­”
  - âœ” çº¯çŸ¥è¯† QA
  - âœ” ä¸éœ€è¦å¤šæ­¥æ¨ç†

ä¸€å¥è¯ï¼šå¿«ï¼Œä½†ä¸Šé™ä½

## ä¸€ã€æ•´ä½“æ¶æ„ï¼ˆå…ˆçœ‹å…¨è²Œï¼‰

```pgsql
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  User /    â”‚
    â”‚  Frontend  â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   RAGFlow    â”‚  â† åªè´Ÿè´£ï¼šæ–‡æ¡£ / æ£€ç´¢ / Prompt
    â”‚ (UI + API)   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ RAG Context
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Agent Gateway (ä½ å†™)    â”‚  â­ æ ¸å¿ƒ
    â”‚  FastAPI / Python        â”‚
    â”‚                          â”‚
    â”‚  - è°ƒ vLLM (tool call)    â”‚
    â”‚  - è§£æ tool_call         â”‚
    â”‚  - è°ƒ fastMCP             â”‚
    â”‚  - Loop until final      â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚
        â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  vLLM    â”‚   â”‚ fastMCP   â”‚
    â”‚ (LLM)    â”‚   â”‚ Tool Svc  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## äºŒã€å„ç»„ä»¶èŒè´£ï¼ˆéå¸¸é‡è¦ï¼‰

### 1. RAGFlowï¼ˆä¸è¦æ”¹å®ƒï¼‰

- èŒè´£

  1. æ–‡æ¡£ ingestion
  2. å‘é‡æ£€ç´¢
  3. Prompt æ¨¡æ¿ç®¡ç†
  4. UI / API

- ä½ åªç”¨å®ƒçš„ï¼š

  1. /api/v1/chat æˆ– /completion ç±»æ¥å£
  2. è¿”å›ï¼šretrieved_context

**æ³¨ï¼š**ğŸ‘‰ ä¸è¦åœ¨ RAGFlow é‡Œæ Agent / Tool

### 2. vLLMï¼ˆæ ¸å¿ƒæ¨ç†å¼•æ“ï¼‰

- èŒè´£

  1. æœ¬åœ°æ¨¡å‹æ¨ç†
  2. æ”¯æŒ OpenAI-compatible API
  3. æ”¯æŒ tool / function calling

- æ¨èæ¨¡å‹ï¼š

  1. Qwen2.5 / Qwen2.5-Instruct
  2. Llama3.x Instruct
  3. Yi / InternLMï¼ˆå·¥å…·èƒ½åŠ›ç¨å¼±ï¼‰

### 3. fastMCPï¼ˆå·¥å…·ç³»ç»Ÿï¼‰

- èŒè´£

  1. ç”¨ MCP æ ‡å‡†æš´éœ²å·¥å…·
  2. å·¥å…·æè¿° = schema
  3. å·¥å…·è°ƒç”¨ = å¼ºç±»å‹

- å®ƒæ˜¯ä½ ï¼š

  1. æ•°æ®åº“
  2. ä¸šåŠ¡ç³»ç»Ÿ
  3. Shell / OS
  4. ç¬¬ä¸‰æ–¹ API

### 4. Agent Gatewayï¼ˆä½ è¦å†™çš„ï¼‰

è¿™æ˜¯å”¯ä¸€éœ€è¦ä½ åŠ¨è„‘çš„åœ°æ–¹ã€‚

- èŒè´£

  1. è°ƒ RAGFlow
  2. è°ƒ vLLM
  3. è¯†åˆ« tool_call
  4. è°ƒ fastMCP
  5. Loop

## ä¸‰ã€æœ€å°å¯è¿è¡Œæµç¨‹ï¼ˆä¸€æ­¥ä¸å¤šï¼‰

### Step 1ï¼šå¯åŠ¨ vLLMï¼ˆOpenAI æ¨¡å¼ï¼‰

```bash
     vllm serve Qwen/Qwen2.5-7B-Instruct \
       --served-model-name qwen \
       --enable-auto-tool-choice \
       --tool-call-parser json \
       --port 8001
```

æ¥å£ï¼š

```bash
    POST http://localhost:8001/v1/chat/completions
```

### Step 2ï¼šå¯åŠ¨ fastMCP Server

```python
     from fastmcp import FastMCP

     mcp = FastMCP("tools")

     @mcp.tool()
     def search_order(order_id: str) -> dict:
         return {
             "order_id": order_id,
             "status": "shipped"
         }

     mcp.run(port=8002)
```

### Step 3ï¼šAgent Gatewayï¼ˆæ ¸å¿ƒä»£ç ï¼‰

1. â‘  MCP Client

   ```python
      from fastmcp import Client

      mcp_client = Client("http://127.0.0.1:8002")
   ```

2. â‘¡ Tool Schemaï¼ˆå–‚ç»™ vLLMï¼‰

   ```python
      TOOLS = [
       {
           "type": "function",
           "function": {
               "name": "search_order",
               "description": "æŸ¥è¯¢è®¢å•çŠ¶æ€",
               "parameters": {
                   "type": "object",
                   "properties": {
                       "order_id": {"type": "string"}
                   },
                   "required": ["order_id"]
               }
           }
       }
   ]
   ```

3. â‘¢ è°ƒ vLLMï¼ˆç¬¬ä¸€æ¬¡ï¼‰

   ```python
      import requests

      def call_llm(messages):
          return requests.post(
              "http://127.0.0.1:8001/v1/chat/completions",
              json={
                  "model": "qwen",
                  "messages": messages,
                  "tools": TOOLS,
                  "tool_choice": "auto"
              }
          ).json()

   ```

4. â‘£ å¤„ç† tool_call â†’ fastMCP

   ```python
      import asyncio

      async def handle_tool_call(call):
          async with mcp_client:
              return await mcp_client.call_tool(
                  call["name"],
                  call["arguments"]
              )
   ```

5. â‘¤ Agent Loopï¼ˆå…³é”®ï¼‰

```python
   async def agent_run(user_input, rag_context):
       messages = [
           {
               "role": "system",
               "content": "ä½ æ˜¯ä¸€ä¸ªå¯ä»¥ä½¿ç”¨å·¥å…·çš„åŠ©æ‰‹"
           },
           {
               "role": "user",
               "content": f"""
                        å·²çŸ¥ä¿¡æ¯ï¼š
                        {rag_context}

                        ç”¨æˆ·é—®é¢˜ï¼š
                        {user_input}
                        """
           }
       ]

       while True:
           resp = call_llm(messages)
           msg = resp["choices"][0]["message"]

           if "tool_calls" not in msg:
               return msg["content"]

           for call in msg["tool_calls"]:
               result = await handle_tool_call(call["function"])
               messages.append(msg)
               messages.append({
                   "role": "tool",
                   "tool_call_id": call["id"],
                   "content": str(result)
               })

```

### Step 4ï¼šRAGFlow â†’ Agent Gateway

ä½ çš„è°ƒç”¨é“¾åº”è¯¥æ˜¯ï¼š

```sql
   User
    â†“
   RAGFlowï¼ˆæ‹¿ contextï¼‰
    â†“
   Agent Gatewayï¼ˆä¸Šé¢çš„ agent_runï¼‰
    â†“
   æœ€ç»ˆå›ç­”
```

## å››ã€Prompt å…³é”®ç‚¹ï¼ˆå†³å®šæˆè´¥ï¼‰

System Prompt å¿…é¡»å†™æ¸…æ¥š

```text
   ä½ å¯ä»¥ä½¿ç”¨å·¥å…·æ¥è·å–å®æ—¶æˆ–ç³»ç»Ÿæ•°æ®ã€‚
   å¦‚æœé—®é¢˜ä»…é å·²æœ‰çŸ¥è¯†æ— æ³•å›ç­”ï¼Œå¿…é¡»è°ƒç”¨å·¥å…·ã€‚
   å·¥å…·è¿”å›åï¼Œå†ç»™å‡ºæœ€ç»ˆç»“è®ºã€‚
```

ç”¨æˆ·é—®é¢˜ + RAG Context ä¸€èµ·å–‚

è¿™æ˜¯ RAG + Agent çš„èåˆç‚¹ã€‚

## äº”ã€å¸¸è§å‘ï¼ˆä½ å¤§æ¦‚ç‡ä¼šè¸©ï¼‰

- âŒ 1. è®© RAGFlow ç›´æ¥è°ƒ fastMCP

  â†’ æ¶æ„é”™

- âŒ 2. æ²¡æœ‰ Agent Loop

  â†’ å·¥å…·åªä¼šè°ƒç”¨ä¸€æ¬¡

- âŒ 3. vLLM æ²¡å¼€ tool_call

  â†’ æ¨¡å‹æ°¸è¿œä¸ä¼šè°ƒç”¨å·¥å…·

- âŒ 4. æ¨¡å‹é€‰é”™

  â†’ 7B ä»¥ä¸‹ tool èƒ½åŠ›å¾ˆå¼±

## å…­ã€è¿›é˜¶æ¼”è¿›è·¯çº¿

### Phase 1

- å•å·¥å…·
- å•è½® tool call

### Phase 2

- å¤šå·¥å…·
- å·¥å…·é€‰æ‹©
- RAG / Tool äºŒé€‰ä¸€

### Phase 3

- Planner / Executor åˆ†ç¦»
- Tool æƒé™æ§åˆ¶ï¼ˆMCP å¤©ç”Ÿé€‚åˆï¼‰
- å¤š Agent

## ä¸ƒã€ä¸€å¥ç»ˆææ€»ç»“

- RAGFlow = æŸ¥èµ„æ–™çš„ä¸“å®¶
- vLLM = å†³ç­–ä¸­æ¢ï¼ˆåšæ¨ç†+å·¥å…·å†³ç­–ï¼‰
- Agent Gateway = ç¥ç»ç³»ç»Ÿ&è°ƒåº¦å™¨
- fastMCP = æ‰‹å’Œè„š

è¿™å¥—æ¶æ„å®Œå…¨å¯¹é½ç°åœ¨ä¸»æµ Agent ç³»ç»Ÿè®¾è®¡ï¼Œä¸æ˜¯ Demoï¼Œæ˜¯æ­£è·¯ã€‚

##

1ï¸âƒ£ å®Œæ•´ repo ç›®å½•ç»“æ„ï¼ˆèƒ½ç›´æ¥è·‘ï¼‰
2ï¸âƒ£ RAGFlow API â†’ Agent Gateway çš„çœŸå®æ¥å…¥ç¤ºä¾‹
3ï¸âƒ£ Prompt + Tool è°ƒç”¨æˆåŠŸç‡è°ƒä¼˜æŠ€å·§
4ï¸âƒ£ agent/runner.py çš„å®Œæ•´å¯è¿è¡Œç‰ˆæœ¬
1ï¸âƒ£ RAG Prompt + Tool Prompt å†²çªçš„è°ƒä¼˜æ–¹æ³•ï¼ˆå‘½ä¸­ç‡ä¼šæ˜æ˜¾æå‡ï¼‰
2ï¸âƒ£ å¤šçŸ¥è¯†åº“ + å¤šå·¥å…·é€‰æ‹©ç­–ç•¥ï¼ˆPlanner ç®€åŒ–ç‰ˆï¼‰
âœ… Tool è°ƒç”¨å‘½ä¸­ç‡è°ƒä¼˜ï¼ˆPrompt & Schema å®æˆ˜ï¼‰
âœ… å¤šå·¥å…·é€‰æ‹© + Plannerï¼ˆä¸å¼• LangChainï¼‰
