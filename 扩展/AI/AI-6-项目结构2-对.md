# AI-6-项目结构 2-对

## Repo 总体结构（推荐）

```bash
agent-gateway/
├─ README.txt
├─ pyproject.toml
├─ uv.lock
├─ Dockerfile
├─ docker-compose.yml
├─ .env.example
│
├─ configs/                     # ===== 系统级配置（配置 > 代码）========
│  ├─ app.py                    # 应用配置（端口、日志、环境）
│  ├─ model.py                  # 模型路由 / vLLM / Embedding
│  ├─ security.py               # Auth / RateLimit
│  ├─ observability.py          # 日志 / Trace / Audit / Replay
│  └─ feature_flags.py          # 实验 / 灰度
│
├─ app/                         # ===== Agent Gateway（入口层）==❗不允许推理逻辑进入 app/====
│  ├─ main.py                   # FastAPI 启动
│  ├─ api/
│  │  ├─ agent.py               # /agent/* 唯一入口
│  │  └─ health.py
│  ├─ middleware/
│  │  ├─ auth.py
│  │  ├─ ratelimit.py
│  │  ├─ session.py
│  │  └─ audit.py               # 请求级审计
│  ├─ schemas/
│  │  ├─ request.py
│  │  ├─ response.py
│  │  └─ context.py
│  └─ lifespan.py
│
├─ agents/                      # ====== Agent Control Plane（唯一决策权）======
│  ├─ registry.py               # 多 Agent 注册 / 路由
│  ├─ base.py                   # Agent 抽象接口
│  │
│  ├─ default_agent/
│  │  ├─ graph.py               # LangGraph 状态机
│  │  ├─ state.py               # AgentState 定义
│  │  ├─ nodes/
│  │  │  ├─ intent.py           # 意图识别
│  │  │  ├─ planner.py          # 规划
│  │  │  ├─ act.py              # Tool 决策
│  │  │  ├─ observe.py          # Observation / Reflect
│  │  │  └─ finalize.py         # Final Answer
│  │  └─ prompts/
│  │     ├─ system.txt
│  │     ├─ planner.txt
│  │     └─ reflect.txt
│  │
│  └─ utils/
│     ├─ cost.py                # Token / 成本估算
│     └─ decision.py
│
├─ policies/                    # ====== Agent Policy（⭐ 核心）=== ❗Policy ≠ Prompt ===
│  ├─ agent_policy.py           # Agent 行为约束
│  ├─ tool_policy.py            # Tool ACL / Budget / Timeout
│  ├─ user_policy.py            # 用户 / 角色
│  ├─ enforcement.py            # Policy 执行器
│  └─ validators.py
│
├─ tools/                       # ===== Tool Control Plane + Data Plane === ❗Tool 永远无状态、无推理 ===
│  ├─ base.py                   # Tool 抽象类（无状态）
│  │
│  ├─ mcp/                      # fastMCP 治理层
│  │  ├─ client.py              # MCP Client
│  │  ├─ registry.py            # Tool Registry
│  │  └─ schemas.py
│  │
│  ├─ ragflow/
│  │  ├─ tool.py                # RAGFlow Tool Adapter
│  │  └─ mapper.py
│  │
│  ├─ search/
│  │  └─ tool.py
│  │
│  ├─ db/
│  │  └─ tool.py
│  │
│  └─ actions/
│     └─ tool.py                # 写操作 / 运维动作
│
├─ runtimes/                    # ==== Agent Runtime 可替换 === ❗允许 Agent Runtime 热切换 ===
│  ├─ langgraph/
│  │  ├─ executor.py
│  │  └─ adapter.py
│  ├─ langchain/
│  │  └─ executor.py
│  └─ custom/
│     └─ executor.py
│
├─ storage/                     # ==== 审计 / Replay / Memory（完成态标志）===❗企业级 Agent 的分水岭 ===
│  ├─ audit/
│  │  ├─ writer.py              # Thought / Action / Observe
│  │  └─ reader.py
│  ├─ replay/
│  │  ├─ loader.py              # 加载历史执行
│  │  └─ runner.py              # 重放 Agent
│  ├─ memory/
│  │  ├─ short_term.py
│  │  └─ long_term.py
│  └─ models.py
│
├─ scripts/                     # ======= 运维 / 管理工具========
│  ├─ seed_tools.py
│  ├─ replay_agent.py
│  ├─ export_audit.py
│  └─ migrate.py
│
├─ tests/
│  ├─ test_agent_graph.py
│  ├─ test_policy.py
│  ├─ test_tools.py
│  ├─ test_replay.py
│  └─ fixtures/
│
└─ docs/
   ├── architecture.md
   ├── agent_design.md
   ├── tool_contract.md
   ├── policy_design.md
   ├── replay_and_audit.md
   └── runbook.md
```

- 关键说明（不是装饰，是架构判定线）

1. 任何请求只能进 app/api/agent.py
2. 任何决策只能发生在 agents/
3. 任何权限 / 预算 / 次数控制只能在 policies/
4. 任何外部能力只能以 tools/ 形式存在
5. 任何 Agent 行为都能在 storage/audit + replay 中重现

满足这 5 条，就是 100% 正确架构。
